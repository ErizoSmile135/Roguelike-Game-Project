{"version":3,"sources":["file:///C:/GameECSProject/assets/scripts/systems/MovementSystem.ts"],"names":["MovementSystem","AttackIntent","MoveIntent","Position","EnemyTag","eventBus","findPathInTemplate","constructor","em","currentRoom","RoomNumber","dirs","x","y","update","dt","movers","getEntityWithComponent","actor","mi","getComponent","target","pos","path","removeComponent","length","emit","entity","occupants","findEntitiesAtPosition","enemy","find","id","hasComponent","addComponent","result","p","push"],"mappings":"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","sourcesContent":["import { AttackIntent } from \"../components/intent/AttackIntent\";\nimport { MoveIntent } from \"../components/intent/MoveIntent\";\nimport { Position } from \"../components/Position\";\nimport { EnemyTag } from \"../components/Tag/EnemyTag\";\nimport { EntityManager } from \"../core/EntityManager\";\nimport { eventBus } from \"../core/EventBus\";\nimport { findPathInTemplate } from \"../core/Pathfinding\";\nimport { RoomTemplate } from \"../data/types\";\n\nexport class MovementSystem {\n    constructor(\n        private em: EntityManager,\n        private currentRoom: RoomTemplate[]\n    ) { }\n\n    private RoomNumber: number = 0;\n\n    private dirs = [\n        { x:  1, y:  0 },\n        { x: -1, y:  0 },\n        { x:  0, y:  1 },\n        { x:  0, y: -1 },\n    ];\n\n    public update(dt: number) {\n        const movers = this.em.getEntityWithComponent(MoveIntent);\n        for (const actor of movers) {\n            const mi = this.em.getComponent(actor, MoveIntent)!;\n            const { x, y } = mi.target;\n            const pos = this.em.getComponent(actor, Position)!;\n            pos.x = x;\n            pos.y = y;\n\n            const path = findPathInTemplate(this.currentRoom[this.RoomNumber], pos, mi.target);\n            \n            this.em.removeComponent(actor, MoveIntent);\n\n            if (path && path.length) {\n                eventBus.emit(\"movePath\", { entity: actor, path });\n            }\n\n            const occupants = this.findEntitiesAtPosition(x, y);\n\n            // если есть враг — планируем атаку\n            const enemy = occupants.find(id => this.em.hasComponent(id, EnemyTag));\n            if (enemy != null) {\n                this.em.addComponent(actor, new AttackIntent(enemy), AttackIntent);\n                continue;\n            }\n\n            // если есть ловушка\n            /*const trap = occupants.find(id => this.entityManager.hasComponent(id, TrapComponent));\n            if (trap != null) {\n                this.entityManager.addComponent(actor, new TrapIntent(trap), TrapIntent);\n                continue;\n            }*/\n\n            // …другие проверки: двери → TransitionIntent и т.п.\n        }\n    }\n\n    private findEntitiesAtPosition(x: number, y: number): number[] {\n        const result: number[] = [];\n        for (const id of this.em.getEntityWithComponent(Position)) {\n            const p = this.em.getComponent(id, Position)!;\n            if (p.x === x && p.y === y) result.push(id);\n        }\n        return result;\n    }\n}\n"]}