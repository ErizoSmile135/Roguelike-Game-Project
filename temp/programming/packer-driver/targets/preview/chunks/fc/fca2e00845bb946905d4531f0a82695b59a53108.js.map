{"version":3,"sources":["file:///C:/GameECSProject/assets/scripts/systems/RenderSystem.ts"],"names":["RenderSystem","instantiate","Vec3","Node","PlayerTag","PrefabNames","EnemyTag","TileTag","Position","ViewComponent","SceneController","eventBus","constructor","entityManager","prefabs","gameRoot","tilesLayer","entityLayer","playerLayer","tileSize","on","entity","newPos","view","getComponent","node","setPosition","x","y","getPrefabName","entityId","hasComponent","Player","Enemy","Tile","render","entities","getEntityWithComponent","prefabName","id","position","console","log","addComponent","prefab","EventType","TOUCH_END","_instance","onTileTapped","addChild","update","dt"],"mappings":"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","sourcesContent":["import { instantiate, Prefab, Vec3, Node, UITransform } from \"cc\";\nimport { EntityManager } from \"../core/EntityManager\";\nimport { PlayerTag } from \"../components/Tag/PlayerTag\";\nimport { PrefabNames } from \"../data/consts\";\nimport { EnemyTag } from \"../components/Tag/EnemyTag\";\nimport { TileTag } from \"../components/Tag/TileTag\";\nimport { Position } from \"../components/Position\";\nimport { ViewComponent } from \"../components/core/ViewComponent\";\nimport { SceneController } from \"../core/SceneController\";\nimport { PrefabType } from \"../data/types\";\nimport { eventBus } from \"../core/EventBus\";\n\nexport class RenderSystem {\n    constructor(private entityManager: EntityManager,\n                private prefabs: Record<PrefabType, Prefab>,\n                private gameRoot: Node,\n                private tilesLayer: Node,\n                private entityLayer: Node,\n                private playerLayer: Node,\n                private tileSize: number\n    ){\n        eventBus.on<{ entity: number; newPos: Position }>(\n            \"positionChanged\",\n            ({ entity, newPos }) => {\n                const view = this.entityManager.getComponent(entity, ViewComponent);\n                if (view?.node) {\n                    view.node.setPosition(\n                        new Vec3(newPos.x * this.tileSize, newPos.y * this.tileSize, 0)\n                    );\n                }\n            }\n        );\n    }\n\n    getPrefabName(entityId: number): PrefabType | null {\n        if (this.entityManager.hasComponent(entityId, PlayerTag)) return PrefabNames.Player;\n        if (this.entityManager.hasComponent(entityId, EnemyTag)) return PrefabNames.Enemy;\n        if (this.entityManager.hasComponent(entityId, TileTag)) return PrefabNames.Tile;\n        return null;\n    }\n\n    render(){\n        const entities = this.entityManager.getEntityWithComponent(Position);\n\n        for (const id of entities) {\n            const prefabName = this.getPrefabName(id);\n            if (!prefabName) continue;\n            const position = this.entityManager.getComponent(id, Position);\n            if (!position) continue;\n\n            let view = this.entityManager.getComponent(id, ViewComponent);\n            if(!view){\n                console.log(prefabName);\n                view = new ViewComponent(prefabName);\n                this.entityManager.addComponent(id, view, ViewComponent);\n                \n                const prefab = this.prefabs[prefabName];\n                const node = instantiate(prefab);\n                node.setPosition(new Vec3(position.x * this.tileSize, position.y * this.tileSize, 0));\n\n                /*if (prefabName === 'Tile') node.getComponent(UITransform).priority = 0;\n                else if (prefabName === 'Enemy') node.getComponent(UITransform).priority = 1;\n                else if (prefabName === 'Player') node.getComponent(UITransform).priority = 2;*/\n                //node.setSiblingIndex(this.gameRoot.children.length - 1);\n                \n                /*switch (prefabName) {\n                    case PrefabNames.Tile:\n                        node.setSiblingIndex(0);\n                        break;\n                    case PrefabNames.Enemy:\n                        node.setSiblingIndex(1);\n                        break;\n                    case PrefabNames.Player:\n                        node.setSiblingIndex(entities.length - 1);\n                        break;\n                }*/\n                \n                if (prefabName === PrefabNames.Tile) \n                    node.on(Node.EventType.TOUCH_END, () => {\n                        SceneController._instance?.onTileTapped(position);\n                    });\n\n                if (prefabName === PrefabNames.Player)\n                    this.playerLayer.addChild(node);\n                else if (prefabName === PrefabNames.Tile) \n                    this.tilesLayer.addChild(node);\n                else if (prefabName === PrefabNames.Enemy) \n                    this.entityLayer.addChild(node);\n                \n                view.node = node;    \n\n                //console.log('add ' + prefabName + position.x + position.y)\n                //console.log(\"Added node\", node.name, \"at\", node.getPosition());\n                //console.log(node.isValid, node.activeInHierarchy, node.getWorldPosition());\n            }\n        }\n    }\n\n    update(dt: number) {\n        /*const entities = this.entityManager.getEntityWithComponent(ViewComponent);\n        for (const id of entities) {\n            const view = this.entityManager.getComponent(id, ViewComponent);\n            const pos  = this.entityManager.getComponent(id, Position);\n            if (view?.node && pos) {\n                view.node.setPosition(\n                    new Vec3(pos.x * this.tileSize, pos.y * this.tileSize, view.node.getPosition().z)\n                );\n            }\n        }*/\n    }\n\n    /*function inputFromVec2(entity: number, type: string, vec: Vec2) {\n        return new InputComponent(entity, type as any, vec.x, vec.y);\n    }*/\n}\n\n"]}