{"version":3,"sources":["file:///C:/GameECSProject/assets/scripts/systems/RenderSystem.ts"],"names":["RenderSystem","instantiate","Vec3","Node","UITransform","PlayerTag","PrefabNames","EnemyTag","TileTag","Position","ViewComponent","SceneController","constructor","entityManager","prefabs","gameRoot","getPrefabName","entityId","hasComponent","Player","Enemy","Tile","render","entities","getEntityWithComponent","prefabName","id","position","getComponent","view","console","log","addComponent","prefab","node","setPosition","x","y","priority","on","EventType","TOUCH_END","instance","onTileTapped","addChild"],"mappings":"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","sourcesContent":["import { instantiate, Prefab, Vec3, Node, UITransform } from \"cc\";\nimport { EntityManager } from \"../core/EntityManager\";\nimport { PlayerTag } from \"../components/Tag/PlayerTag\";\nimport { PrefabNames } from \"../data/consts\";\nimport { EnemyTag } from \"../components/Tag/EnemyTag\";\nimport { TileTag } from \"../components/Tag/TileTag\";\nimport { Position } from \"../components/Position\";\nimport { ViewComponent } from \"../components/core/ViewComponent\";\nimport { SceneController } from \"../core/SceneController\";\nimport { PrefabType } from \"../data/types\";\n\nexport class RenderSystem {\n    constructor(private entityManager: EntityManager,\n                private prefabs: Record<PrefabType, Prefab>,\n                private gameRoot: Node\n    ){}\n\n    getPrefabName(entityId: number): PrefabType | null {\n        if (this.entityManager.hasComponent(entityId, PlayerTag)) return PrefabNames.Player;\n        if (this.entityManager.hasComponent(entityId, EnemyTag)) return PrefabNames.Enemy;\n        if (this.entityManager.hasComponent(entityId, TileTag)) return PrefabNames.Tile;\n        return null;\n    }\n\n    render(){\n        const entities = this.entityManager.getEntityWithComponent(Position);\n\n        for (const id of entities) {\n            const prefabName = this.getPrefabName(id);\n            if (!prefabName) continue;\n            const position = this.entityManager.getComponent(id, Position);\n            if (!position) continue;\n\n            let view = this.entityManager.getComponent(id, ViewComponent);\n            if(!view){\n                console.log(prefabName);\n                view = new ViewComponent(prefabName);\n                this.entityManager.addComponent(id, view, ViewComponent);\n                \n                const prefab = this.prefabs[prefabName];\n                const node = instantiate(prefab);\n                node.setPosition(new Vec3(position.x * 64, position.y * 64, 0));\n\n                if (prefabName === 'Tile') node.getComponent(UITransform).priority = 0;\n                else if (prefabName === 'Enemy') node.getComponent(UITransform).priority = 1;\n                else if (prefabName === 'Player') node.getComponent(UITransform).priority = 2;\n                \n                if (prefabName === 'Tile') \n                    node.on(Node.EventType.TOUCH_END, () => {\n                        SceneController.instance?.onTileTapped(position);\n                    });\n\n                this.gameRoot.addChild(node);\n                view.node = node;    \n\n                //console.log('add ' + prefabName + position.x + position.y)\n                //console.log(\"Added node\", node.name, \"at\", node.getPosition());\n                //console.log(node.isValid, node.activeInHierarchy, node.getWorldPosition());\n            }\n        }\n    }\n\n    /*function inputFromVec2(entity: number, type: string, vec: Vec2) {\n        return new InputComponent(entity, type as any, vec.x, vec.y);\n    }*/\n}\n\n"]}